global
    log stdout format raw local0
    # For extra security, we'll use a DH-Params file
    ssl-dh-param-file /etc/letsencrypt/ssl-dhparams.pem
    # Modern secure SSL settings
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s

frontend http_frontend
    bind *:80
    # Allow ACME challenge requests for Let's Encrypt certificate renewal
    acl letsencrypt_acl path_beg /.well-known/acme-challenge/
    # Redirect all other HTTP traffic to HTTPS
    redirect scheme https code 301 if !letsencrypt_acl
    # Serve ACME challenges
    use_backend letsencrypt_backend if letsencrypt_acl

frontend https_frontend
    # Bind to port 443 and use the combined certificate file
    bind *:443 ssl crt /etc/letsencrypt/live/sphere.unicity.network/haproxy.pem alpn h2,http/1.1

    mode http

    # Add security headers
    http-response set-header Strict-Transport-Security "max-age=16000000; includeSubDomains; preload;"

    # Route /game requests to game backend (port 3011)
    acl game_acl path_beg /game
    use_backend game_backend if game_acl

    # Route /api requests to backend API (port 3000)
    acl api_acl path_beg /api
    use_backend api_backend if api_acl

    # By default, send all traffic to UI (port 5173)
    default_backend ui_backend

backend ui_backend
    # Forward traffic to UI running on localhost port 5173
    server ui 127.0.0.1:5173 check

backend api_backend
    # Forward /api requests to API running on localhost port 3000
    # Strip /api prefix before forwarding
    http-request set-path %[path,regsub(^/api,)]
    server api 127.0.0.1:3000 check

backend game_backend
    # Forward /game requests to game service on localhost port 3011
    # Strip /game prefix before forwarding
    http-request set-path %[path,regsub(^/game,)]
    server game 127.0.0.1:3011 check

backend letsencrypt_backend
    # Serve ACME challenges from webroot directory
    server letsencrypt 127.0.0.1:8080 check
